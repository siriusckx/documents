## TCP/IP协议分层
1. 应用层:HTTP、SMTP、POP3、FTP
1. 传输层:TCP、UDP
1. 网络层（互联网层）:IP、ICMP
1. 链路层（网卡）:ARP、RARP,PPP （驱动编程、硬件开发）

> SOCKET编程，最多只到网络层。

### 网络层
1. 分组
1. 路由
1. 路由算法
1. 网络层的协议
   * IP协议
   * ICMP协议
   * IGMP协议

### 传输层
1. 数据的分块在这一段来做
1. 会自动将数据分成合适的小块，没有数据包的大小问题，无非就是缓存的大小，应用层无需关注大小。
1. TCP确保数据能够发到。
2. UDP只管发，但不确定能够发到。

### 应用层
1. Telnet远程登录协议
1. FTP文件传输协议
1. SMTP简单邮件传送协议
1. SNMP简单网络管理协议
> 对于实际应用程序来说，这一层还可以按照ISO中的会话层->表示层->应用层来组织；尤其是会话层的实现，是推荐考虑的模型；

### OSI会话层简介
1. 会话层建立、管理和终止表示层（或应用层）与实体之间的通信会话；
1. 通信会话包括发生在不同网络应用层之间的服务请求和服务应答，这些请求与应答通过会话层的协议实现。
1. 它还包括创建检查点，使通信发生中断的时候可以返回到以前的一个状态；（如：断点续传，重新登录某游戏等）

### OSI表示层简介
1. 表示层提供多种功能用于应用层数据编码和转化，以确保以一个系统应用层发送的信息可以被另一个系统应用层识别；
1. 表示层的编码和转化模式包括公用数据表示格式、性能转化表示格式、公用数据压缩模式和公用数据加密模式。
1. 公用数据表示格式就是标准的图像、声音和视频格式；
1. 通过使用这些标准格式，不同类型的计算机系统可以相互交换数据；
1. 转化模式通过使用不同的文本和数据表示，在系统间交换信息，如ASCII
1. 标准数据压缩模式确保原始设备上被压缩的数据可以在目标设备上正确的解压；
1. 加密模式确保原始设备上加密的数据可以在目标设备上正确地解密；
1. 表示层协议一般不与特殊的协议栈关联，如QuickTime是Applet计算机的视频和音频的标准，MPEG是ISO的视频压缩与编码标准；
1. 常见的图形图像格式PCX、GIF、JPEG是不同的静态图像压缩和编码标准；
1. 目标是对数据和模式的标准化、规范化。解决数据结构和数据之间转换的问题。

### 链路层
1. 为IP模块发送和接收IP数据报；
1. 为ARP模块发送ARP请求和接收ARP应答；
1. 为RARP发送RARP请求和接收RARP应答；
1. TCP/IP支持多种不同的链路层协议，这取决于网络所使用的硬件。
1. 由于链路层比较接近硬件/驱动程序，普通SOCKET也已无法在该层有所作为。

#### 最大传输单元MTU
1. 链路层-最大传输单元MTU。不同的网络层协议，最大的传输单元大小不一样。
1. MTU对上层传输的影响
   * 在通讯两端的虚拟路径上，整条路径的MTU就是最小的那段路径的MTU
   * IP数据报是直接面对链路层的数据包，因此超过MTU大小（实际还要减去包头长度）的IP数据报会被分解为适合大小的IP数据分片。
   * 这些被拆分的数据分片只在发送端拆分，并且只在接收端组装
   * 若某个数据分片丢失或传输错误都将导致所有的数据分片被要求从发送端重新发送
   * 对于更上层的TCP/UDP来说，TCP为了保证可靠传输，内部对数据在上层已经考虑了适合MTU单元大小的拆分，但是传输数据分片失败仍然会导致其效率低下
   * 对于UDP报来说，此时往往会发生整个UDP报被丢弃的问题
   * 在使用UDP协议时要自行考虑MTU大小的包拆分，对于TCP来说一般不用考虑
   * 在广域网的时候要考虑，在局域网内一般不考虑

## 理解分层
### 局域网FTP通讯模型（Windows）
### 跨子网FTP通讯模型示意图（Windows）
### 从二进制角度看IPv4地址分类
1. 无前缀码
### 封装（TCP至底层数据包逐层封装示意图）
### 分用
1. 当目的主机收到一个以太网数据帧时，数据就开始从协议栈中由底向上升，同时云掉各层协议加上的报文首部；
1. 每层协议盒都要去检查报文首部中的协议标识，以确定接收数据的上层协议。
### 客户-服务器模型分类
1. 服务端分两种类型：重复型或并发型
1. 重复型服务器通过以下步骤进行交互
   * a1. 等待一个客户连接请求的到来
   * a2. 处理客户请求 
   * a3. 发送响应给发送请求的客户
   * a4. 返回a1步
1. 并发型服务采用以下步骤
   

### TCP/IP标准控制组织
> 事实上，有四个小组在负责Internet技术
1. Internet协会（推动、支持和促进）
1. Internet体系结构委员会（最后编辑和技术审核）
1. Internet工程专门小组（面向近期的）
1. Internet研究专门小组（研究长远的）

### RFC
1. 正式标准都以RFC文档出版
1. 大量的RFC并不是正式的标准，出版的目的只是为了提供信息
1. 每一项都用一个数字来标识，如RFC1122,数字越大说明RFC的内容越新
1. http://www.rfc-editor.org
1. http://www.cnpaf.net/class/rfcall/

### 一些简单标准服务

### 网际协议
1. IP是TCP/IP协议族中最为核心的协议；
1. 所有的TCP、UDP、ICMP及IGMP数据都以IP数据报格式传输；
1. IP提供不可靠、无连接的数据报（面向消息）传送服务；
1. 不可靠（unreliable）的意思是它不能保证IP数据报能成功地到达目的地；
1. IP仅提供最好的传输服务；
1. 如果发生某种错误时，如某个路由器暂时用完了缓冲区，IP有一个简单的错误处理算法：丢弃该数据报，然后发送ICMP消息报给信源端；
1. 任何要求的可靠性必须由上层来提供（如TCP）；
1. 无连接（connectionless）这个术语的意思是IP并不维护任何关于后续数据报的状态信息；
1. 每个数据报的处理是相互独立的；
1. 这也说明，IP数据报可以不按发送顺序接收；
1. 如果一信源向相同的信宿发送两个连续的数据报（先是A，然后B），每个数据报都是独立地进行路由选择，可能选择不同的路线，因此B可能在A到达之前先到达；
   
#### IP首部
1. 普通IP首部长为20个字节，除非含有选项字段；
1. TOS服务类型
1. 网络中标识，序号的作用
1. 3位控制标识的作用
1. TTL 生存时间字段设置了数据报可以经过的最多路由器数；
1. 8位协议，是用来指定上层的协议类型
1. 校验和，不好的地方，会导致路由器的压力会比较大。

#### IP路由
1. 从概念上说，IP路由选择是简单的，特别对于主机来说；
1. 如果目的主机与源主机直接相连（如点对点链路）或都在一个共享网络上（以太网或令牌环网），那么IP数据报就直接送到目的主机上；
1. 否则，主机把数据报发往一默认的路由器上，由路由器来转发该数据报；
1. 大多数的主机都是采用这种简单机制；
1. 另外有些主机上IP层即可以配置成路由器的功能，也可以配置成主机的功能；
1. 当今的大多数主机都可以配置成路由的功能；

#### ICMP:Internet 控制报文协议
#### ICMP目的不可达错误详细代码
#### ICMP地址掩码请求与应答
1. 子网掩码的作用，用来识别局域网的地址，点1网段，点2网段可以相互通信。
#### ICMP时间戳请求与应答
#### ICMP报文的处理

#### UDP:用户数据报协议
1. UDP是一个简单的面向数据报的运输层协议：进程的每个输出操作都正好产生一个UDP数据报，并组装成一份待发送的IP数据报。
1. 这与面向流字符的协议不同，如TCP
1. 利用UDP数据报和直接使用IP数据报的格式差不多

#### UDP首部
#### UDP首部解析
1. TCP和UDP的端口是相互独立的，都可以使用同一个端口，不相互影响。
1. 可以使用UDP违造端口，穿透防火墙。
#### UDP校验和（一）
1. UDP数据报的长度可以为奇数字节，但是检验和算法是把若干个16 bit字相加；解决方法是必要时在最后增加填充字节0，这只是为了检验和的计算。
1. UDP数据包含一个12字长的伪首部，是为了计算检验和而设置。
1. 伪首部包含IP首部一些字段，其目的是让UDP两次检查数据是否已经正确到达目的地。
1. UDP检验和只能防止链路层的电子错误，不能防止恶意的修改。
1. IP和UDP协议，提供的是不安全的数据传输。违造IP数据报，违造UDP数据报，违造TCP数据报。
#### UDP校验和（二）
1. 如果检验和的计算结果为0，则存入的值为全1（65535），这在二进制反码计算中是等效的；
1. 如果传送的检验和为0，说明发送端没有计算检验和；
1. 如果发送端没有计算检验和页接收端检测到检验和有差错，那么UDP数据报就要被悄悄地丢弃；
1. 不产生任何差错报文（当IP层检测到IP首部检验和有差错时也这样做）；
1. UDP检验和是一个端到端的检验和；
1. 它由发送端计算，然后由接收端验证；
1. 其目的是为了发现UDP首站和数据在发送端到接收端之间发生的任何改动；
1. 尽管UDP检验和是可选的，但是它们应该总是在用；
1. 在早期一些计算机生产商在默认条件下关闭UDP检验和的功能，以提高使用UDP协议的NFS的速度。
   
#### UDP伪首部图示
1. 实现UDP时，也会包括IP层的内容，说明层的这种分界不是很严格的，TCP/IP协议族的分层是象征性的。
2. TCP/IP协议这种分层不严格，导致其中一层变动，另外的层次也会跟着变动，导致成形后，改动起来太大了，几十年来都不怎么变。当时之所以采用它，是因为它的路由协议比较不错。
3. 在编写UDP时，还要注意考虑IP包的大小，甚至MTU的大小。

#### TCP:传输控制协议
1. 面向连接的，可靠的字节流服务
1. 面向连接意味着两个使用TCP的应用（通常是一个客户和一个服务器）在彼此交换数据之前必须先建立一个TCP连接；
1. 在一个TCP连接中，仅有两方进行彼此通信；
1. 广播和多播不能用于TCP;
1. 通常TCP服务端可以通过异步操作的方式管理多个与客户端的通讯连接，返过来也是。

#### TCP可靠性
1. 应用数据被分割成TCP认为最适合发送的数据块；这和UDP完全不同，应用程序产生的数据报长度将保持不变；由TCP传递给IP的信息单位称为报文段或段（segment）;
1. 当TCP发出一个段后，它启动一个定时器，等待目的端确认收到这个报文段；如果不能及时收到一个确认，将重发这个报文段；
1. 当TCP收到发自TCP连接另一端的数据，它将发送一个确认；这个确认不是立即发送，通常将推迟几分之一秒；
1. TCP将保持它首部和数据的检验和；这是一个端到端的检验和，目的是检测数据在传输文段作为IP数据报来传输，而IP数据报的到达可能会失序，因此TCP报文段的到达也可能会失序；如果必要，TCP将对收到的数据进行重新排序，将收到的数据以正确的顺序交给应用层；
1. 既然IP数据报会发生重复，TCP的接收端必须丢弃重复的数据；
1. TCP还能提供流量控制；TCP连接的每一方都有固定大小的缓冲空间；TCP的接收端只允许另一端发送接收端缓冲区所能接纳的数据；这将防止较快主机致使用较慢主机的缓冲区溢出；

#### TCP首部解析（1）
1. 每个TCP段都包含源端和目的端的端口号，用于寻找发送和收端应用进程；
1. 这两个值加上IP首部中的源端IP地址和目的端IP地址唯一确定一个TCP连接；这种唯一确定，可以比较容易的被防造；
1. 有时，一个IP地址和一个端口号也称为一个插口（socket);
1. 这个术语出现在最早的TCP规范（RFC 793）中，后来它也作为表示伯克利版的编程接口；
1. 插口对（socketpair）(包含客户IP地址、客户端口号、服务器IP地址和服务器端口号的四元组)可唯一确定互联网络中每个TCP连接的双方；
1. 序号用来标识从TCP发端向TCP收端发送的数据字节流，它表示在这个报文段中的第一个数据字节；
1. 序号的排序

#### TCP首部解析（2）
1. 当建立一个新的连接时，SYN标志变1；
1. 序号字段包含由这个主机选择的该连接的初始序号ISN.
1. 该主机要发送数据的第一个字节序号为这个ISN加1，因为SYN标志消耗了一个序号；
1. 既然每个传输的字节都被计数，确认序号包含发送确认的一端所期望收到的下一个序号；
1. 因此，确认序号应当是上次已成功收到数据字节序号加1；
1. 只有ACK标志为1时确认序号字段才有效；
1. 发送ACK无需任何代价。

#### TCP首部解析（3）
1. TCP滑动窗口的协议

#### TCP首部解析（4）
1. 在TCP首部中有6个标志比特；它们中的多个可同时被设置为1：
   * URG 紧急指针有效
   * ACK 确认序号有效
   * PSH 接收方应该尽快将这个报文段交给应用层；
   * RST 重建连接；
   * SYN 同步序号用来发起一个连接；
   * FIN 发端完成发送任务

#### TCP首部解析（5）
1. TCP的流量控制由连接的每一端通过声明的窗口大小来提供；
1. 窗口大小为字节数，起始于确认序号字段指明的值，这个值是接收端正期望接收的字节；
2. 窗口大小是一个16bit字段，因而窗口大小最大为65535字节；
3. 在之后将介绍新的窗口刻度选项，它允许这个值按比例变化以提供更大的窗口；
4. 检验和覆盖了整个的TCP报文段：TCP首部和TCP数据；这是一个强制性的字段，一定是由发端计算和存储，并由收端进行验证；
5. TCP检验和的计算和UDP检验和的计算相似，使用UDP中类似所的一个伪首部；
6. 只有当URG标专置1时紧急指针才有效；紧急指针是一个正的偏移量，和序号字段中的值相加表示紧急数据最后一个字节的序号；
7. TCP的紧急方式是发送端向另一端发送紧急数据的一种方式；

#### TCP首部解析（6）
1. 最常见的可选字段是最长报文大小，又称为MSS(maximum Segment Size)
2. 每个连接方通常都在通信的第一个报文段（为建立连接而设置SYN标志的那个段）中指明这个选项；
3. 它指明本端所能接收的最大长度的报文段；
4. 如果一方没有数据要发送，也使用没有任何数据的首部来确认收到的数据；
5. 在处理超时的许多情况中，也会发送不带任何数据的报文段；
   
#### TCP连接的建立与终止的过程











